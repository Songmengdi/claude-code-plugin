---
name: code-quality-review
description: 当实现完成、测试通过，但需要在合并到基础分支之前进行代码质量审查时使用
---

# 代码质量审查

## 概述

通过并行代码审查，从不同维度确保代码简单、DRY、优雅、易读且功能正确。

**开始时声明：** "我正在使用 code-quality-review skill 来审查代码质量。"

**上下文：** 在 feature 分支中，实现已完成且测试通过，准备合并到基础分支之前。

## 检查清单创建

你必须将以下的步骤加入到你的任务清单中并按顺序完成：

1. **验证测试通过** — 确保所有测试通过
2. **并行代码审查** — 启动 3 个 code-reviewer agents，从不同维度审查
3. **整合审查结果** — 识别问题并按严重程度排序
4. **呈现审查结果** — 向用户呈现发现，询问处理方式
5. **处理修复决策** — 根据用户决策修复问题或跳过
6. **验证修复** — 修复后验证测试仍然通过

## 流程图

```dot
digraph code-quality-review {
    "验证测试" [shape=box];
    "测试通过?" [shape=diamond];
    "并行代码审查" [shape=box];
    "整合审查结果" [shape=box];
    "呈现审查结果" [shape=box];
    "用户决策?" [shape=diamond];
    "修复问题" [shape=box];
    "验证修复" [shape=box];
    "跳过问题" [shape=box];
    "调用 finishing-a-development-branch" [shape=doublecircle];

    "验证测试" -> "测试通过?";
    "测试通过?" -> "停止并修复" [label="否"];
    "测试通过?" -> "并行代码审查" [label="是"];
    "并行代码审查" -> "整合审查结果";
    "整合审查结果" -> "呈现审查结果";
    "呈现审查结果" -> "用户决策?";
    "用户决策?" -> "修复问题" [label="现在修复"];
    "用户决策?" -> "跳过问题" [label="按原样"];
    "修复问题" -> "验证修复";
    "验证修复" -> "呈现审查结果" [label="需重新审查"];
    "验证修复" -> "调用 finishing-a-development-branch" [label="完成"];
    "跳过问题" -> "调用 finishing-a-development-branch";
}
```

## 过程

### 阶段 1：验证测试

**目标：** 确保所有测试通过

**行动：**

```bash
# 运行项目的测试套件
npm test / cargo test / pytest / go test ./...
```

**如果测试失败：**
- 停止审查流程
- 报告测试失败情况
- 建议先修复测试后再进行代码审查
- 不要继续到阶段 2

**如果测试通过：** 继续到阶段 2

### 阶段 2：并行代码审查

**目标：** 从不同维度全面审查代码质量

**并行启动 3 个 code-reviewer agents**，每个专注于不同方面：

1. **code quality & elegance**：
   - 代码简洁性（simplicity）
   - DRY（Don't Repeat Yourself）
   - 优雅性和可读性
   - 代码结构和组织

2. **functional correctness**：
   - 逻辑错误和 bug
   - 边界情况处理
   - null/undefined handling
   - race conditions
   - 性能问题

3. **project conventions**：
   - 项目约定遵守情况（CLAUDE.md）
   - 框架和库的正确使用
   - import patterns
   - error handling patterns
   - naming conventions
   - testing practices

**审查范围：**

默认审查 `git diff` 中的所有变更（未暂存和已暂存）。

**向每个 code-reviewer agent 提供：**
- 当前分支的所有变更（`git diff` 输出）
- 项目配置文件（CLAUDE.md、package.json、tsconfig.json 等）
- 说明审查范围和专注点

### 阶段 3：整合审查结果

**目标：** 识别问题并按严重程度排序

**行动：**

1. 整合所有 code-reviewer agents 的发现
2. 识别高置信度问题（置信度 ≥ 80）
3. 按严重程度分组问题：
   - **Critical**：影响功能的严重 bug、安全漏洞、性能问题
   - **Important**：代码质量问题、违反项目约定、可维护性问题
   - **Nice to have**：代码风格、小优化建议

4. 移除重复或低置信度问题
5. 准备清晰的呈现格式

### 阶段 4：呈现审查结果

**目标：** 向用户呈现发现，询问处理方式

**呈现格式：**

```
## 代码质量审查结果

### Critical 问题（<N> 个）

[按严重程度排序]

**问题 1：** <brief description>
- 严重程度：Critical
- 置信度：85%
- 位置：`path/to/file.ts:123-145`
- 原因：[详细说明]
- 建议：[具体修复建议]

[更多 Critical 问题...]

### Important 问题（<N> 个）

**问题 1：** <brief description>
- 严重程度：Important
- 置信度：82%
- 位置：`path/to/file.ts:67-89`
- 原因：[详细说明]
- 建议：[具体修复建议]

[更多 Important 问题...]

### Nice to have（<N> 个）

[可选，如果问题较少则呈现]

**问题 1：** <brief description>
- 严重程度：Nice to have
- 位置：`path/to/file.ts:234-256`
- 建议：[具体建议]

[更多 Nice to have 问题...]

---

**统计：**
- Critical：<N> 个
- Important：<N> 个
- Nice to have：<N> 个

**你想要如何处理这些问题？**

1. 立即修复所有 Critical + Important 问题
2. 只修复 Critical 问题
3. 选择性修复（我会指定具体问题）
4. 按原样合并，稍后修复

选择哪个选项？
```

**如果没有发现高置信度问题：**

```
## 代码质量审查结果

✅ **未发现高置信度问题**

代码符合项目标准，可以继续合并流程。

你想要：
1. 继续到合并流程（调用 finishing-a-development-branch）
2. 进行更详细的审查

选择哪个选项？
```

### 阶段 5：处理修复决策

**目标：** 根据用户决策修复问题或跳过

**选项 1：立即修复所有 Critical + Important 问题**

**行动：**
1. 为每个问题创建修复任务
2. 按优先级顺序修复（Critical → Important）
3. 每修复一个问题后，运行测试验证
4. 如果问题数量较多，分批次修复（每批 3-5 个问题）

**选项 2：只修复 Critical 问题**

**行动：**
1. 只为 Critical 问题创建修复任务
2. 修复并验证测试
3. Important 和 Nice to have 问题留待后续

**选项 3：选择性修复**

**行动：**
1. 等待用户指定具体要修复的问题编号
2. 只修复用户指定的问题
3. 验证测试

**选项 4：按原样合并，稍后修复**

**行动：**
1. 记录所有问题到 TODO 文件或技术债列表
2. 跳过修复，直接调用 finishing-a-development-branch

### 阶段 6：验证修复

**目标：** 修复后验证测试仍然通过

**行动：**

```bash
# 运行项目的测试套件
npm test / cargo test / pytest / go test ./...
```

**如果测试失败：**
- 停止修复
- 报告测试失败情况
- 等待用户指示
- 可能需要回滚某些修复

**如果测试通过：**
- 如果还有剩余问题需要修复，返回到阶段 5 继续修复
- 如果所有选择的问题都已修复，继续到下一步

### 阶段 7：完成审查

**目标：** 调用下一个流程

**行动：**

如果所有问题都已修复，或用户选择按原样合并：

```
代码质量审查已完成。

✅ 测试通过
✅ 代码质量问题已处理（或选择跳过）

接下来调用 **finishing-a-development-branch** 技能来完成合并流程。
```

调用 finishing-a-development-branch skill。

## 何时停止并寻求帮助

**立即停止并寻求帮助当：**

- 修复一个问题时导致多个新问题
- 测试反复失败，无法定位原因
- 问题的修复方案不明确
- 修复问题可能影响系统稳定性
- 用户对修复方案有疑问

**不要猜测修复方案。**

## 何时重新审查

**重新运行并行代码审查当：**

- 修复了 Critical 或 Important 问题后
- 用户要求重新审查
- 修复过程中引入了新的重大变更

## 记住

- **并行优于串行** — 使用多个 agents 并行审查不同维度
- **质量优于速度** — 不要为了快速合并而跳过重要修复
- **置信度过滤** — 只报告高置信度问题（≥ 80）
- **用户决策优先** — 让用户决定是否修复，不要强制
- **验证修复** — 每次修复后都要运行测试
- **逐步修复** — 按优先级顺序修复，分批次进行

## 快速参考

| 阶段 | 行动 | 输出 |
|------|------|------|
| 1. 验证测试 | 运行测试套件 | ✅ 测试通过 |
| 2. 并行审查 | 启动 3 个 code-reviewer agents | 审查发现 |
| 3. 整合结果 | 去重、排序、分类 | 问题列表 |
| 4. 呈现结果 | 按严重程度呈现 | 用户决策 |
| 5. 修复问题 | 根据决策修复 | 修复的代码 |
| 6. 验证修复 | 运行测试套件 | ✅ 测试通过 |
| 7. 完成 | 调用下一个技能 | 准备合并 |

## 常见错误

**跳过测试验证**
- **问题：** 代码有 bug 但通过了审查
- **修复：** 审查前和修复后必须验证测试

**修复所有问题而不分优先级**
- **问题：** 浪费时间在低优先级问题上
- **修复：** Critical → Important → Nice to have

**不验证修复就继续**
- **问题：** 修复引入了新 bug
- **修复：** 每次修复后都要运行测试

**一次性修复太多问题**
- **问题：** 难以定位哪个修复导致了问题
- **修复：** 分批次修复（每批 3-5 个问题）

**忽略用户决策**
- **问题：** 用户可能选择按原样合并
- **修复：** 尊重用户决策，不要强制修复

## 红旗警告

**永远不要：**
- 在测试失败的情况下继续审查
- 修复问题后不验证测试
- 强制用户修复所有问题
- 猜测修复方案
- 一次性修复过多问题

**总是：**
- 审查前验证测试
- 修复后验证测试
- 让用户决定是否修复
- 按优先级顺序修复
- 分批次修复问题

## 工作流程说明

此技能在以下工作流程中使用：

1. **brainstorming** - 创建 feature 分支
2. **writing-plans** - 编写实施计划
3. **executing-plans** - 执行计划
4. **code-quality-review** - 代码质量审查（此技能）
5. **finishing-a-development-branch** - 合并到基础分支

**何时使用：**
- 实现完成后，需要严格审查代码质量
- 团队重视代码质量
- 需要在合并前确保代码符合项目标准

**何时不使用：**
- 快速原型开发
- 临时修复或紧急 patch
- 代码已经过充分测试和审查
